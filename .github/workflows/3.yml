name: Spyware filtered

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  filter-and-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Spyware Filter
        env:
          TZ: 'Asia/Seoul'
        run: |
          TARGET_URL="https://raw.githubusercontent.com/qcontinuum1/spying-extensions/refs/heads/main/README.md"
          OUTPUT_FILE="spyware_chromewebextension.txt"
          
          curl -sL "$TARGET_URL" -o readme.md
          
          if [ ! -s readme.md ]; then
            echo "CRITICAL_FAILURE=true" >> $GITHUB_ENV
            exit 1
          fi

          echo "! Source: https://raw.githubusercontent.com/qcontinuum1/spying-extensions/main/README.md" > "$OUTPUT_FILE"

          sed -n '/## The Honeypot/,/### IoCs/p' readme.md | grep -o '`[^`]*`' | tr -d '`' | sort -u > targets.txt
          
          grep -oE 'chromewebstore\.google\.com/detail/[a-p]{32}' readme.md | sort -u > urls.txt

          while read -r target; do
            if [ -n "$target" ]; then
              echo "||${target}^\$all,reason=Spyware" >> "$OUTPUT_FILE"
            fi
          done < targets.txt

          while read -r url; do
            if [ -n "$url" ]; then
              echo "||${url}\$all,reason=Spyware" >> "$OUTPUT_FILE"
            fi
          done < urls.txt

          rm readme.md targets.txt urls.txt

      - name: Deploy to Isolate Branch
        if: always()
        env:
          TZ: 'Asia/Seoul'
        run: |
          if [ "$CRITICAL_FAILURE" == "true" ]; then
             exit 1
          fi
          
          OUTPUT_FILE="spyware_chromewebextension.txt"
          
          mkdir -p /tmp/filter_output
          mv "$OUTPUT_FILE" /tmp/filter_output/
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git fetch origin Isolate || true
          
          if git show-ref --verify --quiet refs/remotes/origin/Isolate; then
             git checkout Isolate
             git pull origin Isolate --rebase
          else
             git checkout --orphan Isolate
             git rm -rf .
          fi
          
          mv /tmp/filter_output/"$OUTPUT_FILE" .
          
          git add "$OUTPUT_FILE"
          
          if ! git diff --staged --quiet; then
            git commit -m "Auto update Spyware rules: $(date +'%Y-%m-%d %H:%M:%S') KST"
            git push origin Isolate
          fi
